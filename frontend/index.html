<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gemini-style Chat ‚Äî Demo</title>

  <!-- Google font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1724;
      --panel:#0b1220;
      --muted:#9aa4b2;
      --accent1:#7c5cff;
      --accent2:#5eead4;
      --glass: rgba(255,255,255,0.04);
      --danger:#ff6b6b;
      --success:#2ed573;
    }
    *{box-sizing:border-box;font-family:Inter,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    html,body{height:100%;margin:0;background:
      radial-gradient(1200px 600px at 10% 10%, rgba(124,92,255,0.08), transparent 6%),
      radial-gradient(1000px 500px at 90% 90%, rgba(94,234,212,0.04), transparent 6%),
      var(--bg); color:#d3dde6;}
    a{color:inherit}
    .app {
      max-width:1100px;
      margin:28px auto;
      display:grid;
      grid-template-columns:320px 1fr 320px;
      gap:20px;
      padding:20px;
    }

    /* sidebar */
    .card {
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03);
      border-radius:14px;
      padding:16px;
      box-shadow: 0 6px 30px rgba(2,6,23,0.6);
    }
    .logo {
      display:flex;gap:12px;align-items:center;margin-bottom:14px;
    }
    .logo .blob {
      width:44px;height:44px;border-radius:10px;
      background:linear-gradient(135deg,var(--accent1),var(--accent2));
      box-shadow:0 6px 20px rgba(92,64,255,0.14);
      display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;
    }
    .muted{color:var(--muted);font-size:13px}

    nav button{
      width:100%;
      display:flex;justify-content:space-between;align-items:center;
      padding:10px 12px;border-radius:10px;border:0;background:transparent;color:inherit;
      cursor:pointer;font-weight:600;margin-bottom:8px;
    }
    nav button.active{background:linear-gradient(90deg, rgba(124,92,255,0.12), rgba(94,234,212,0.03));}

    /* center panel ‚Äî chat */
    .panel {
      display:flex;flex-direction:column;height:80vh;
      border-radius:14px;overflow:hidden;
    }
    .panel .header {
      display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.02);
      background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    }
    .panel .messages {
      flex:1; padding:20px; overflow:auto; background:
      linear-gradient(180deg, rgba(255,255,255,0.003), transparent);
    }
    .input-area {
      padding:12px;border-top:1px solid rgba(255,255,255,0.02);display:flex;gap:8px;background:var(--panel);
    }
    textarea{flex:1;border-radius:10px;padding:12px;background:var(--glass);border:1px solid rgba(255,255,255,0.02);color:inherit;resize:none;height:56px}
    .btn {
      padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:700;
      background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#051223;
    }
    .message {padding:12px 14px;border-radius:12px;margin-bottom:10px;max-width:78%;}
    .msg-user{background:linear-gradient(90deg, rgba(124,92,255,0.14), rgba(94,234,212,0.04));align-self:flex-end;}
    .msg-bot{background:rgba(255,255,255,0.02);align-self:flex-start;color:var(--muted);}
    .small{font-size:12px;color:var(--muted);}

    /* right panel ‚Äî account & prompts */
    .prompt-item{padding:10px;border-radius:10px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.02);background:rgba(255,255,255,0.01)}
    .prompt-item pre{white-space:pre-wrap;margin:0;font-family:inherit;font-size:13px}

    /* forms */
    form {display:flex;flex-direction:column;gap:8px}
    input,select{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    .danger{background:linear-gradient(90deg, rgba(255,107,107,0.12), rgba(255,107,107,0.02));border-color:rgba(255,107,107,0.08)}
    .success-dot{width:10px;height:10px;border-radius:50%;background:var(--success);display:inline-block;margin-right:8px}

    /* tiny */
    .flex{display:flex;gap:8px;align-items:center}
    .right {margin-left:auto}
    .center {text-align:center}
    .hidden{display:none}
    footer{color:var(--muted);font-size:13px;margin-top:12px;text-align:center}
    .error{color:var(--danger);font-weight:700}
    .ok{color:var(--success);font-weight:700}
    @media (max-width:1000px){
      .app{grid-template-columns:1fr; padding:12px}
      .app > :not(:first-child){margin-top:16px}
      .panel{height:70vh}
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT: navigation -->
    <div class="card" id="left">
      <div class="logo">
        <div class="blob">G</div>
        <div>
          <div style="font-weight:800">Gemini-style Chat</div>
          <div class="muted">AI frontend demo</div>
        </div>
      </div>

      <div id="nav">
        <nav>
          <button id="nav-chat" class="active">–ß–∞—Ç</button>
          <button id="nav-prompts">–ú–æ–∏ –ø—Ä–æ–º–ø—Ç—ã</button>
          <button id="nav-account">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</button>
          <button id="nav-auth">–í–æ–π—Ç–∏ / –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </nav>
      </div>

      <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0">

      <div class="muted">–°—Ç–∞—Ç—É—Å</div>
      <div style="margin-top:10px" id="statusArea">
        <div class="flex">
          <span id="statusDot" class="success-dot" style="display:none"></span>
          <div id="statusText" class="muted">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>
        </div>
        <div style="margin-top:10px" id="userSmall" class="muted hidden"></div>
      </div>

      <footer>
        –°–¥–µ–ª–∞–Ω–æ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ ¬∑ –¢–µ—Å—Ç–∏—Ä—É–π –ª–æ–∫–∞–ª—å–Ω–æ
      </footer>
    </div>

    <!-- CENTER: chat -->
    <div class="panel card">
      <div class="header">
        <div>
          <div style="font-weight:800" id="panelTitle">–ß–∞—Ç</div>
          <div class="small" id="panelSub">–ü–æ–≥–æ–≤–æ—Ä–∏ —Å –Ω–µ–π—Ä–æ–Ω–∫–æ–π ‚Äî —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</div>
        </div>
        <div class="flex">
          <button class="btn" id="btnRefreshPrompts" title="–û–±–Ω–æ–≤–∏—Ç—å –º–æ–∏ –ø—Ä–æ–º–ø—Ç—ã">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
      </div>

      <div class="messages" id="messages">
        <div class="center muted" id="welcomeMsg">
          <div style="font-size:20px;font-weight:700;margin-bottom:8px">–ü—Ä–∏–≤–µ—Ç! üëã</div>
          <div class="muted">–í–æ–π–¥–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç –∏ –Ω–∞—á–Ω–∏ –¥–∏–∞–ª–æ–≥ ‚Äî —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ú–æ–∏ –ø—Ä–æ–º–ø—Ç—ã¬ª</div>
        </div>
      </div>

      <div class="input-area">
        <textarea id="promptInput" placeholder="–ù–∞–ø–∏—à–∏ –ø—Ä–æ–º–ø—Ç..." aria-label="prompt"></textarea>
        <button class="btn" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <!-- RIGHT: prompts & account -->
    <div class="card" id="right">
      <!-- prompts list -->
      <div id="promptsView">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
          <div style="font-weight:700">–ú–æ–∏ –ø—Ä–æ–º–ø—Ç—ã</div>
          <div class="muted small">–ó–¥–µ—Å—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏—Å—Ç–æ—Ä–∏—è</div>
        </div>
        <div id="promptsList">
          <div class="muted">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –≤–æ–π–¥–∏ –∏ –æ—Ç–ø—Ä–∞–≤—å –ø–µ—Ä–≤—ã–π –ø—Ä–æ–º–ø—Ç</div>
        </div>
      </div>

      <!-- account view -->
      <div id="accountView" class="hidden">
        <div style="font-weight:700;margin-bottom:8px">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</div>
        <div id="accountInfo" class="muted small">–ó–∞–ª–æ–≥–∏–Ω—å—Å—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</div>

        <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0">

        <div style="font-weight:700;margin-bottom:6px">–°–º–µ–Ω–∏—Ç—å –∏–º—è</div>
        <form id="formChangeName">
          <input type="text" id="newName" placeholder="–ù–æ–≤–æ–µ –∏–º—è" required />
          <input type="password" id="namePassword" placeholder="–ü–∞—Ä–æ–ª—å" required />
          <div class="flex">
            <button class="btn" type="submit">–°–º–µ–Ω–∏—Ç—å –∏–º—è</button>
            <span id="changeNameResult" class="muted small"></span>
          </div>
        </form>

        <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0">

        <div style="font-weight:700;margin-bottom:6px">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</div>
        <form id="formChangePassword">
          <input type="password" id="oldPassword" placeholder="–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å" required />
          <input type="password" id="newPassword" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å" required />
          <input type="password" id="repeatNewPassword" placeholder="–ü–æ–≤—Ç–æ—Ä –Ω–æ–≤–æ–≥–æ –ø–∞—Ä–æ–ª—è" required />
          <div class="flex">
            <button class="btn" type="submit">–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
            <span id="changePassResult" class="muted small"></span>
          </div>
        </form>

        <hr style="border:none;height:1px;background:rgba(255,255,255,0.02);margin:12px 0">

        <div style="font-weight:700;margin-bottom:6px">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</div>
        <form id="formDeleteUser">
          <input type="password" id="deletePassword" placeholder="–ü–∞—Ä–æ–ª—å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è" required />
          <div class="flex">
            <button class="btn danger" type="submit">–£–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
            <span id="deleteResult" class="muted small"></span>
          </div>
        </form>
      </div>

      <!-- auth view -->
      <div id="authView" class="hidden">
        <div style="font-weight:700;margin-bottom:8px">–í–æ–π—Ç–∏ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</div>

        <div style="display:flex;gap:8px;margin-bottom:12px">
          <button id="showLogin" class="btn" style="flex:1">–í–æ–π—Ç–∏</button>
          <button id="showRegister" class="btn" style="flex:1">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>

        <div id="loginPanel" class="">
          <form id="formLogin">
            <input type="email" id="loginEmail" placeholder="Email" required />
            <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" required />
            <div class="flex">
              <button class="btn" type="submit">–í–æ–π—Ç–∏</button>
              <span id="loginResult" class="muted small"></span>
            </div>
          </form>
        </div>

        <div id="registerPanel" class="hidden">
          <form id="formRegister">
            <input type="text" id="regName" placeholder="–ò–º—è" required />
            <input type="email" id="regEmail" placeholder="Email" required />
            <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å" required />
            <input type="password" id="regRepeatPassword" placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required />
            <div class="flex">
              <button class="btn" type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
              <span id="regResult" class="muted small"></span>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>

  <script>
    /* ====== CONFIG ====== */
    const API_BASE = ''; // –µ—Å–ª–∏ backend –Ω–∞ —Ç–æ–º –∂–µ —Ö–æ—Å—Ç–µ ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –ø—É—Å—Ç—ã–º. –ò–Ω–∞—á–µ –Ω–∞–ø—Ä–∏–º–µ—Ä 'http://localhost:8000'
    // used endpoints (as in —Ç–≤–æ—ë–º –∫–æ–¥–µ)
    const ENDPOINTS = {
      sign_up: API_BASE + '/users/sign_up',
      sign_in: API_BASE + '/users/sign_in',
      get_info: API_BASE + '/users/get_info',
      change_password: API_BASE + '/users/change_password',
      change_name: API_BASE + '/users/change_name',
      delete_user: API_BASE + '/users/delete_user',
      send_prompt: API_BASE + '/send_prompt',
      get_current_requests: API_BASE + '/get_current_requests'
    };

    /* ====== helpers ====== */
    function el(id){ return document.getElementById(id) }
    function show(elm){ elm.classList.remove('hidden') }
    function hide(elm){ elm.classList.add('hidden') }
    function setText(id, text){ el(id).textContent = text }

    async function apiFetch(path, opts = {}) {
      // default: send JSON and include cookies
      const headers = opts.headers || {};
      if (opts.json !== undefined) {
        headers['Content-Type'] = 'application/json';
        opts.body = JSON.stringify(opts.json);
        delete opts.json;
      }
      const res = await fetch(path, {
        credentials: 'include',
        ...opts,
        headers
      });
      let data = null;
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) data = await res.json().catch(()=>null);
      else data = await res.text().catch(()=>null);
      if (!res.ok) {
        // try to show useful error
        const msg = (data && data.detail) ? data.detail : (data && data.message) ? data.message : (typeof data === 'string' ? data : '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        const err = new Error(msg || 'HTTP error');
        err.status = res.status;
        err.payload = data;
        throw err;
      }
      return data;
    }

    /* ====== state ====== */
    let state = {
      user: null,
      token: localStorage.getItem('token') || null
    };

    /* ====== UI wiring ====== */
    const navChat = el('nav-chat'), navPrompts = el('nav-prompts'), navAccount = el('nav-account'), navAuth = el('nav-auth');
    const panelTitle = el('panelTitle'), panelSub = el('panelSub');
    const messages = el('messages'), promptInput = el('promptInput'), sendBtn = el('sendBtn');
    const promptsList = el('promptsList'), promptsView = el('promptsView');
    const accountView = el('accountView'), authView = el('authView');
    const statusText = el('statusText'), statusDot = el('statusDot'), userSmall = el('userSmall');

    function setActiveNav(btn){
      [navChat, navPrompts, navAccount, navAuth].forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
    }

    navChat.onclick = () => {
      setActiveNav(navChat);
      el('panelTitle').textContent = '–ß–∞—Ç';
      el('panelSub').textContent = '–ü–æ–≥–æ–≤–æ—Ä–∏ —Å –Ω–µ–π—Ä–æ–Ω–∫–æ–π ‚Äî —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç';
      hide(accountView); hide(authView);
      show(promptsView);
    };
    navPrompts.onclick = async () => {
      setActiveNav(navPrompts);
      el('panelTitle').textContent = '–ú–æ–∏ –ø—Ä–æ–º–ø—Ç—ã';
      el('panelSub').textContent = '–ò—Å—Ç–æ—Ä–∏—è —Ç–≤–æ–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –Ω–µ–π—Ä–æ–Ω–∫–µ';
      hide(accountView); hide(authView);
      show(promptsView);
      await loadPrompts();
    };
    navAccount.onclick = async () => {
      setActiveNav(navAccount);
      el('panelTitle').textContent = '–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç';
      el('panelSub').textContent = '–ò–∑–º–µ–Ω–∏ –¥–∞–Ω–Ω—ã–µ –∏–ª–∏ —É–¥–∞–ª–∏ –∞–∫–∫–∞—É–Ω—Ç';
      hide(promptsView); hide(authView);
      show(accountView);
      await loadAccountInfo();
    };
    navAuth.onclick = () => {
      setActiveNav(navAuth);
      el('panelTitle').textContent = '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è';
      el('panelSub').textContent = '–í–æ–π–¥–∏—Ç–µ –∏–ª–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å';
      hide(promptsView); hide(accountView);
      show(authView);
    };

    // auth toggles
    el('showLogin').onclick = () => {
      show(el('loginPanel')); hide(el('registerPanel'));
    };
    el('showRegister').onclick = () => {
      show(el('registerPanel')); hide(el('loginPanel'));
    };

    /* ====== auth actions ====== */
    el('formRegister').onsubmit = async (e) => {
      e.preventDefault();
      const name = el('regName').value.trim();
      const email = el('regEmail').value.trim();
      const password = el('regPassword').value;
      const repeat_password = el('regRepeatPassword').value;
      el('regResult').textContent = '...';
      try {
        const data = await apiFetch(ENDPOINTS.sign_up, { method: 'POST', json: { name, email, password, repeat_password } });
        el('regResult').textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω ‚Äî –º–æ–∂–Ω–æ –≤–æ–π—Ç–∏';
        el('regResult').className = 'muted small ok';
        // auto-switch to login
        show(el('loginPanel')); hide(el('registerPanel'));
      } catch (err) {
        el('regResult').textContent = err.message || '–û—à–∏–±–∫–∞';
        el('regResult').className = 'muted small error';
      }
    };

    el('formLogin').onsubmit = async (e) => {
      e.preventDefault();
      const email = el('loginEmail').value.trim();
      const password = el('loginPassword').value;
      el('loginResult').textContent = '...';
      try {
        const data = await apiFetch(ENDPOINTS.sign_in, { method: 'POST', json: { email, password } });
        // backend sets cookie via Set-Cookie if same-origin and credentials:include
        // but backend also returns token in body ‚Äî keep it for UI
        if (data && data.token) {
          localStorage.setItem('token', data.token);
          state.token = data.token;
        }
        el('loginResult').textContent = '–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω';
        el('loginResult').className = 'muted small ok';
        await loadAccountInfo();
        updateAuthState(true);
        // switch to chat
        navChat.click();
      } catch (err) {
        el('loginResult').textContent = err.message || '–û—à–∏–±–∫–∞';
        el('loginResult').className = 'muted small error';
      }
    };

    async function loadAccountInfo() {
      try {
        const data = await apiFetch(ENDPOINTS.get_info, { method: 'GET' });
        if (data && data.info) {
          state.user = data.info;
          userSmall.textContent = `@${state.user.name} ¬∑ ${state.user.email}`;
          show(userSmall);
          el('accountInfo').innerHTML = `<div><strong>${escapeHtml(state.user.name)}</strong></div><div class="muted small">${escapeHtml(state.user.email)}</div>`;
          updateAuthState(true);
        } else {
          updateAuthState(false);
        }
      } catch (err) {
        updateAuthState(false);
      }
    }

    function updateAuthState(isLoggedIn) {
      if (isLoggedIn) {
        statusText.textContent = '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
        show(statusDot);
        state.isLoggedIn = true;
      } else {
        statusText.textContent = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
        hide(statusDot);
        state.isLoggedIn = false;
        state.user = null;
        localStorage.removeItem('token');
        state.token = null;
        hide(userSmall);
      }
    }

    /* ====== chat ====== */
    sendBtn.onclick = sendPrompt;
    promptInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendPrompt(); }
    });

    async function sendPrompt() {
      const prompt = promptInput.value.trim();
      if (!prompt) return;
      // show user message
      appendMessage(prompt, 'user');
      promptInput.value = '';
      // require login
      if (!state.isLoggedIn) {
        appendMessage('–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–º–ø—Ç.', 'bot');
        return;
      }
      // send to backend
      try {
        appendMessage('–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ—Ç–≤–µ—Ç... (–ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏)', 'bot', true);
        const resp = await apiFetch(ENDPOINTS.send_prompt, { method: 'POST', json: { prompt } });
        removeTempBot();
        const answer = resp && resp.gemini ? resp.gemini : (resp && resp.answer) ? resp.answer : '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞';
        appendMessage(answer, 'bot');
        // refresh prompts list
        await loadPrompts();
      } catch (err) {
        removeTempBot();
        appendMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ' + (err.message || '–æ—à–∏–±–∫–∞'), 'bot');
      }
    }

    function appendMessage(text, who = 'bot', isTemp = false) {
      hide(el('welcomeMsg'));
      const div = document.createElement('div');
      div.className = 'message ' + (who === 'user' ? 'msg-user' : 'msg-bot');
      if (isTemp) { div.dataset.temp = '1'; div.style.opacity = '0.75'; }
      div.innerHTML = `<div style="white-space:pre-wrap">${escapeHtml(text)}</div><div class="small" style="margin-top:8px">${who==='user' ? '–¢—ã' : '–ù–µ–π—Ä–æ—Å–µ—Ç—å'}</div>`;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }
    function removeTempBot(){
      const temps = messages.querySelectorAll('[data-temp="1"]');
      temps.forEach(n=>n.remove());
    }

    /* ====== prompts list ====== */
    async function loadPrompts() {
      try {
        promptsList.innerHTML = '<div class="muted">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
        const data = await apiFetch(ENDPOINTS.get_current_requests, { method: 'GET' });
        const arr = (data && data.your_prompts) ? data.your_prompts : [];
        if (!arr.length) {
          promptsList.innerHTML = '<div class="muted">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞ ‚Äî –æ—Ç–ø—Ä–∞–≤—å –ø—Ä–æ–º–ø—Ç –≤ —á–∞—Ç–µ</div>';
          return;
        }
        promptsList.innerHTML = '';
        // show newest first
        arr.reverse().forEach(item => {
          const elp = document.createElement('div'); elp.className = 'prompt-item';
          const p_prompt = document.createElement('div'); p_prompt.innerHTML = `<strong>–ü—Ä–æ–º–ø—Ç:</strong><pre>${escapeHtml(item.prompt||'')}</pre>`;
          const p_answer = document.createElement('div'); p_answer.style.marginTop='8px';
          p_answer.innerHTML = `<strong>–û—Ç–≤–µ—Ç:</strong><pre>${escapeHtml(item.answer||'')}</pre>`;
          elp.appendChild(p_prompt); elp.appendChild(p_answer);
          promptsList.appendChild(elp);
        });
      } catch (err) {
        promptsList.innerHTML = `<div class="error">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã: ${escapeHtml(err.message||'–û—à–∏–±–∫–∞')}</div>`;
      }
    }
    el('btnRefreshPrompts').onclick = loadPrompts;

    /* ====== account actions ====== */
    el('formChangeName').onsubmit = async (e) => {
      e.preventDefault();
      const new_name = el('newName').value.trim();
      const password = el('namePassword').value;
      el('changeNameResult').textContent = '...';
      try {
        const data = await apiFetch(ENDPOINTS.change_name, { method: 'PUT', json: { password, new_name } });
        el('changeNameResult').textContent = '–ò–º—è –∏–∑–º–µ–Ω–µ–Ω–æ';
        el('changeNameResult').className = 'muted small ok';
        await loadAccountInfo();
      } catch (err) {
        el('changeNameResult').textContent = err.message || '–û—à–∏–±–∫–∞';
        el('changeNameResult').className = 'muted small error';
      }
    };

    el('formChangePassword').onsubmit = async (e) => {
      e.preventDefault();
      const old_password = el('oldPassword').value;
      const new_password = el('newPassword').value;
      const repeat_new_password = el('repeatNewPassword').value;
      el('changePassResult').textContent = '...';
      try {
        const data = await apiFetch(ENDPOINTS.change_password, { method: 'PUT', json: { old_password, new_password, repeat_new_password } });
        el('changePassResult').textContent = '–ü–∞—Ä–æ–ª—å –∏–∑–º–µ–Ω—ë–Ω';
        el('changePassResult').className = 'muted small ok';
      } catch (err) {
        el('changePassResult').textContent = err.message || '–û—à–∏–±–∫–∞';
        el('changePassResult').className = 'muted small error';
      }
    };

    el('formDeleteUser').onsubmit = async (e) => {
      e.preventDefault();
      if (!confirm('–¢—ã —É–≤–µ—Ä–µ–Ω(–∞)? –£–¥–∞–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ ‚Äî –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ–µ.')) return;
      const password = el('deletePassword').value;
      el('deleteResult').textContent = '...';
      try {
        const data = await apiFetch(ENDPOINTS.delete_user, { method: 'DELETE', json: { password } });
        el('deleteResult').textContent = '–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª—ë–Ω';
        el('deleteResult').className = 'muted small ok';
        // log out locally
        updateAuthState(false);
        navAuth.click();
      } catch (err) {
        el('deleteResult').textContent = err.message || '–û—à–∏–±–∫–∞';
        el('deleteResult').className = 'muted small error';
      }
    };

    /* ====== small utilities ====== */
    function escapeHtml(unsafe) {
      if (unsafe === null || unsafe === undefined) return '';
      return String(unsafe)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'", '&#039;');
    }

    // init: try to get user info
    (async function init() {
      try {
        await loadAccountInfo();
        if (state.isLoggedIn) {
          // pre-load prompts
          await loadPrompts();
        }
      } catch (err) {
        updateAuthState(false);
      }
    })();

    // quick keyboard navigation
    window.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'k') {
        promptInput.focus();
      }
    });

  </script>
</body>
</html>
